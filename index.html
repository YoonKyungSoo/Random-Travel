<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>랜덤 여행지 픽! 🗺️✈️</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
     <!-- 카카오맵 API 스크립트 -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c837a316c42b3e191934f21e1921839f"></script>
    
</head>

<body>
    <div class="container">
        <header>
            <h1>🗺️ 랜덤 여행지 픽!</h1>
            <p>한국 지도에서 운명의 여행지를 찾아보세요!</p>
        </header>

        <div class="main-content">
            <!-- 지도 컨테이너 -->
            <div class="map-container">
          <div id="map" style="width:100%;height:400px;"></div>
            </div>

            <!-- 기본 컨트롤 버튼들 -->
            <div class="controls">
                <div class="desktop-controls">
                    <button id="randomPickBtn" class="btn primary">🎯 랜덤 여행지 픽!</button>
                    <button id="resetBtn" class="btn secondary">🔄 다시하기</button>
                    <button id="favoriteBtn" class="btn accent hidden">❤️ 즐겨찾기</button>
                </div>
                <div class="mobile-controls">
                    <button id="randomPickBtnMobile" class="btn primary">🎯 랜덤픽!</button>
                    <button id="favoriteBtnMobile" class="btn accent">❤️ 즐겨찾기</button>
                    <button id="favoritesListBtnMobile" class="btn secondary">📋 찜 리스트</button>
                </div>
            </div>

            <!-- 결과 표시 영역 -->
            <div id="resultCard" class="result-card hidden">
                <h3>🎉 여행지가 선택되었습니다!</h3>
                <div id="locationInfo">
                    <p id="locationName"></p>
                    <p id="locationDescription"></p>
                </div>
                <div class="action-buttons">
                    <button id="shareBtn" class="btn small">📤 공유하기</button>
                </div>
            </div>

                    <!-- 즐겨찾기 목록 영역 -->
        <div id="favoritesSection" class="favorites-section">
            <h3>❤️ 즐겨찾기한 여행지</h3>
            <div id="favoritesContainer"></div>
        </div>
        
        <!-- 즐겨찾기 팝업 -->
        <div id="favoritesPopup" class="favorites-popup">
            <div class="popup-content">
                <div class="popup-header">
                    <h3>❤️ 즐겨찾기한 여행지</h3>
                    <button id="closePopupBtn" class="close-btn">×</button>
                </div>
                <div class="popup-body">
                    <div id="popupFavoritesContainer"></div>
                </div>
            </div>
        </div>
        </div>
    </div>
    
   
    <!-- 지역 데이터 파일들 -->
    <script src="locations/seoul-locations.js"></script>
    <script src="locations/busan-locations.js"></script>
    <script src="locations/daegu-locations.js"></script>
    <script src="locations/incheon-locations.js"></script>
    <script src="locations/gwangju-locations.js"></script>
    <script src="locations/daejeon-locations.js"></script>
    <script src="locations/ulsan-locations.js"></script>
    <script src="locations/sejong-locations.js"></script>
    <script src="locations/gyeonggi-locations.js"></script>
    <script src="locations/gangwon-locations.js"></script>
    <script src="locations/chungbuk-locations.js"></script>
    <script src="locations/chungnam-locations.js"></script>
    <script src="locations/jeonbuk-locations.js"></script>
    <script src="locations/jeonnam-locations.js"></script>
    <script src="locations/gyeongbuk-locations.js"></script>
    <script src="locations/gyeongnam-locations.js"></script>
    <script src="locations/jeju-locations.js"></script>
    
    <!-- 애플리케이션 기능 -->
    <script src="script.js"></script>
    <script>
        var tempMarker = null;
        var routeMap1 = null;
        var routeMap2 = null;
        
        // 페이지 로드 시 지도 초기화
        window.addEventListener('load', function() {
            // 카카오맵 API 로딩 확인 및 초기화
            checkKakaoMapAPI();
            
            // 저장된 즐겨찾기 불러오기
            loadFavorites();
        });
        
        // 카카오맵 API 로딩 확인
        function checkKakaoMapAPI() {
            if (typeof kakao !== 'undefined' && kakao.maps) {
                console.log('✅ 카카오맵 API 로드 완료!');
                initializeMap();
            } else {
                console.log('카카오맵 API 로딩 대기 중...');
                // 500ms마다 재시도 (최대 10초)
                if (window.kakaoRetryCount === undefined) {
                    window.kakaoRetryCount = 0;
                }
                
                if (window.kakaoRetryCount < 20) { // 10초 대기
                    window.kakaoRetryCount++;
                    setTimeout(checkKakaoMapAPI, 500);
                } else {
                    console.error('카카오맵 API 로드 실패');
                    showMapError();
                }
            }
        }
        
        // 지도 로드 실패 시 오류 표시
        function showMapError() {
            const mapContainer = document.getElementById('map');
            if (mapContainer) {
                mapContainer.innerHTML = `
                    <div style="
                        width: 100%; 
                        height: 100%; 
                        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
                        display: flex; 
                        align-items: center; 
                        justify-content: center;
                        border-radius: 15px;
                        color: white;
                        font-size: 1.2rem;
                        text-align: center;
                        cursor: pointer;
                    " onclick="retryKakaoMap()">
                        <div>
                            <div style="font-size: 3rem; margin-bottom: 15px;">⚠️</div>
                            <div style="font-size: 1.4rem; font-weight: bold; margin-bottom: 10px;">지도 로드 실패</div>
                            <div style="font-size: 1rem; margin-bottom: 20px; opacity: 0.9;">카카오맵 API 연결에 실패했습니다</div>
                            <div style="
                                background: rgba(255,255,255,0.2);
                                padding: 10px 20px;
                                border-radius: 20px;
                                font-size: 0.9rem;
                                cursor: pointer;
                                transition: all 0.3s ease;
                                border: 1px solid rgba(255,255,255,0.3);
                            " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                               onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                클릭하여 다시 시도
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        // 카카오맵 재시도
        function retryKakaoMap() {
            window.kakaoRetryCount = 0;
            checkKakaoMapAPI();
        }
        
        // 카카오맵 초기화
        function initializeMap() {
            try {
                // script.js의 initializeMap 함수 호출
                if (typeof window.initializeMap === 'function') {
                    window.initializeMap();
                    console.log('✅ 카카오맵 초기화 완료!');
                } else {
                    console.error('script.js의 initializeMap 함수를 찾을 수 없습니다.');
                }
            } catch (error) {
                console.error('지도 초기화 오류:', error);
                // 오류 발생 시 재시도
                setTimeout(initializeMap, 1000);
            }
        }
        

        
        // 랜덤 여행지 선택
        function pickRandomLocation() {
            if (!window.map) {
                alert('지도가 로드되지 않았습니다. 잠시 후 다시 시도해주세요.');
                return;
            }
            
            try {
                // script.js의 pickRandomLocation 함수 사용
                if (typeof window.pickRandomLocation === 'function') {
                    window.pickRandomLocation();
                } else {
                    alert('랜덤 여행지 선택 기능을 사용할 수 없습니다.');
                }
            } catch (error) {
                console.error('랜덤 여행지 선택 오류:', error);
                alert('여행지 선택 중 오류가 발생했습니다.');
            }
        }
        
        // 결과 표시
        function showResult(locationName, locationDescription = null) {
            document.getElementById('locationName').textContent = locationName;
            if (locationDescription) {
                document.getElementById('locationDescription').textContent = locationDescription;
            } else {
                document.getElementById('locationDescription').textContent = `${locationName}에서 멋진 여행을 즐겨보세요!`;
            }
            document.getElementById('resultCard').classList.remove('hidden');
            document.getElementById('favoriteBtn').classList.remove('hidden');
        }
        
        // 즐겨찾기 추가
        function addToFavorites(location = null) {
            try {
                // script.js의 addToFavorites 함수 사용
                if (typeof window.addToFavorites === 'function' && location) {
                    window.addToFavorites(location);
                } else {
                    alert('즐겨찾기 기능을 사용할 수 없습니다.');
                }
            } catch (error) {
                console.error('즐겨찾기 추가 오류:', error);
                alert('즐겨찾기 추가 중 오류가 발생했습니다.');
            }
        }
        
        // 즐겨찾기 로드
        function loadFavorites() {
            try {
                // script.js의 updateFavoritesList 함수 사용
                if (typeof window.updateFavoritesList === 'function') {
                    window.updateFavoritesList();
                } else {
                    // fallback: 로컬 스토리지에서 직접 로드
                    const favorites = JSON.parse(localStorage.getItem('travelFavorites') || '[]');
                    const container = document.getElementById('favoritesContainer');
                    
                    if (favorites.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">아직 즐겨찾기한 여행지가 없습니다.<br>랜덤 여행지를 선택하고 ❤️ 즐겨찾기 버튼을 눌러보세요!</p>';
                        return;
                    }
                    
                    container.innerHTML = favorites.map(fav => `
                        <div class="favorite-item" style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: #f9f9f9;">
                            <h5 style="margin: 0 0 10px 0; color: #333;">${fav.name}</h5>
                            ${fav.description ? `<p style="margin: 5px 0; color: #666; font-size: 14px;">${fav.description}</p>` : ''}
                            <p style="margin: 5px 0; color: #888; font-size: 12px;">추가된 날짜: ${new Date(fav.timestamp).toLocaleDateString('ko-KR')}</p>
                            <button onclick="removeFavorite(${fav.id})" class="btn small" style="background: #ff6b6b; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">삭제</button>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('즐겨찾기 로드 오류:', error);
            }
        }
        
        // 즐겨찾기 삭제
        function removeFavorite(id) {
            try {
                // script.js의 removeFavoriteById 함수 사용
                if (typeof window.removeFavoriteById === 'function') {
                    window.removeFavoriteById(id);
                } else {
                    alert('즐겨찾기 삭제 기능을 사용할 수 없습니다.');
                }
            } catch (error) {
                console.error('즐겨찾기 삭제 오류:', error);
                alert('즐겨찾기 삭제 중 오류가 발생했습니다.');
            }
        }
        

        
        // 다시하기
        function reset() {
            try {
                // script.js의 resetMap 함수 사용
                if (typeof window.resetMap === 'function') {
                    window.resetMap();
                } else {
                    // fallback: 기본 리셋 기능
                    if (tempMarker && window.map) {
                        tempMarker.setMap(null);
                        tempMarker = null;
                    }
                    
                    document.getElementById('resultCard').classList.add('hidden');
                    document.getElementById('favoriteBtn').classList.add('hidden');
                    
                    if (window.map) {
                        window.map.setCenter(new kakao.maps.LatLng(36.5, 127.5));
                        window.map.setLevel(7);
                    }
                }
            } catch (error) {
                console.error('리셋 오류:', error);
            }
        }
        
        // 경로 그리기 관련 함수들 (카카오맵 API로 구현)
        function jsCreatRoute(mapName) {
            if (!map) return;
            
            // 카카오맵 API를 사용한 경로 생성
            console.log(`${mapName} 경로 생성 준비`);
            
            if (mapName == 'test1') {
                routeMap1 = {
                    name: mapName,
                    polyline: null,
                    points: []
                };
            } else {
                routeMap2 = {
                    name: mapName,
                    polyline: null,
                    points: []
                };
            }
        }
        
        function jsAddRouteEvent(mapName) {
            if (!map) return;
            
            // 카카오맵 API를 사용한 경로 이벤트 추가
            console.log(`${mapName} 경로 이벤트 추가`);
            
            // 지도 클릭 시 경로에 점 추가
            if (mapName == 'test1' && routeMap1) {
                routeMap1.isActive = true;
            } else if (mapName == 'test2' && routeMap2) {
                routeMap2.isActive = true;
            }
        }
        
        function mClick1(event) {
            if (!routeMap1 || !routeMap1.isActive) return;
            
            // 카카오맵 API를 사용한 클릭 이벤트 처리
            console.log('test1 클릭 이벤트');
            
            // 클릭한 위치를 경로에 추가
            const latlng = event.latLng;
            routeMap1.points.push(latlng);
            
            // 경로 그리기
            drawRoute('test1');
        }
        
        function mClick2(event) {
            if (!routeMap2 || !routeMap2.isActive) return;
            
            // 카카오맵 API를 사용한 클릭 이벤트 처리
            console.log('test2 클릭 이벤트');
            
            // 클릭한 위치를 경로에 추가
            const latlng = event.latLng;
            routeMap2.points.push(latlng);
            
            // 경로 그리기
            drawRoute('test2');
        }
        
        // 경로 그리기 함수
        function drawRoute(mapName) {
            let routeData;
            if (mapName == 'test1') {
                routeData = routeMap1;
            } else {
                routeData = routeMap2;
            }
            
            if (!routeData || routeData.points.length < 2) return;
            
            // 기존 경로 제거
            if (routeData.polyline) {
                routeData.polyline.setMap(null);
            }
            
            // 새 경로 생성
            routeData.polyline = new kakao.maps.Polyline({
                path: routeData.points,
                strokeWeight: 3,
                strokeColor: '#FF0000',
                strokeOpacity: 0.7,
                strokeStyle: 'solid'
            });
            
            routeData.polyline.setMap(map);
        }
        
        function jsInit(mapName) {
            if (!map) return;
            
            // 카카오맵 API를 사용한 경로 초기화
            console.log(`${mapName} 경로 초기화`);
            
            if (mapName == 'test1' && routeMap1) {
                routeMap1.isActive = false;
            } else if (mapName == 'test2' && routeMap2) {
                routeMap2.isActive = false;
            }
        }
        
        function setColor(mapName) {
            if (!map) return;
            
            // 카카오맵 API를 사용한 색상 설정
            console.log(`${mapName} 색상 변경`);
            
            let routeData;
            if (mapName == 'test1') {
                routeData = routeMap1;
            } else {
                routeData = routeMap2;
            }
            
            if (routeData && routeData.polyline) {
                routeData.polyline.setOptions({
                    strokeColor: '#990033'
                });
            }
        }
        
        function setWidth(mapName) {
            if (!map) return;
            
            // 카카오맵 API를 사용한 너비 설정
            console.log(`${mapName} 너비 변경`);
            
            let routeData;
            if (mapName == 'test1') {
                routeData = routeMap1;
            } else {
                routeData = routeMap2;
            }
            
            if (routeData && routeData.polyline) {
                routeData.polyline.setOptions({
                    strokeWeight: 20
                });
            }
        }
        
        function jsRemoveRoute(mapName) {
            if (!map) return;
            
            // 카카오맵 API를 사용한 경로 제거
            console.log(`${mapName} 경로 제거`);
            
            if (mapName == 'test1' && routeMap1) {
                if (routeMap1.polyline) {
                    routeMap1.polyline.setMap(null);
                }
                routeMap1 = null;
            } else if (mapName == 'test2' && routeMap2) {
                if (routeMap2.polyline) {
                    routeMap2.polyline.setMap(null);
                }
                routeMap2 = null;
            }
        }
        
        function closeAllPop(mapName) {
            if (!map) return;
            
            // 카카오맵 API를 사용한 팝업 닫기
            console.log(`${mapName} 팝업 닫기`);
            
            // 모든 정보창 닫기
            const infowindows = document.querySelectorAll('.kakao-map-info-window');
            infowindows.forEach(window => window.style.display = 'none');
        }
        
        function openAllPop(mapName) {
            if (!map) return;
            
            // 카카오맵 API를 사용한 팝업 열기
            console.log(`${mapName} 팝업 열기`);
            
            // 모든 정보창 열기
            const infowindows = document.querySelectorAll('.kakao-map-info-window');
            infowindows.forEach(window => window.style.display = 'block');
        }
        
        // 이벤트 리스너 설정
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('randomPickBtn').addEventListener('click', pickRandomLocation);
            document.getElementById('resetBtn').addEventListener('click', reset);
            document.getElementById('favoriteBtn').addEventListener('click', addToFavorites);
        });
    </script>
</body>

</html>